/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */

define(["underscore","core/rave_view_manager","core/rave_api","core/rave_openajax_hub","core/rave_log","core/rave_state_manager","core/rave_action_manager","osapi"],function(e,t,n,r,i,s,o){function l(){a.rpcRegister("requestNavigateTo",p),a.rpcRegister("set_pref",d),a.rpcRegister("set_title",v),a.rpcRegister("hideWidget",m),a.rpcRegister("showWidget",g)}function c(){a.views.createElementForGadget=function(e,n,r,i,s,o,u){if(i){var a=e&&e.views&&e.views[r],f=t.renderView(i,a),l=f.getWidgetSite();return l.setAttribute("data-rave-view",f._uid),l}},a.views.createElementForEmbeddedExperience=function(e,r,o,u,a,f){function c(e){if(e.error)return i(e.error.message);var n={widgetUrl:l,securityToken:e.securityToken,metadata:r},s=y(n.metadata.modulePrefs),u=b(n.metadata.modulePrefs);E(n);if(o){var a=t.renderView(o,{preferredHeight:s,preferredWidth:u}),c=a.getWidgetSite();c.setAttribute("data-rave-view",a._uid),f(c)}}var l=r.url;n.rest.getSecurityToken({url:l,pageid:s.getPage().id,successCallback:c})},a.views.createElementForUrl=function(e,n,r,i,s){if(n){var o=t.renderView(n),u=o.getWidgetSite();u.setAttribute("data-rave-view",o._uid),s(u)}},a.views.destroyElement=function(e){var n=e.el_;a.closeGadget(e);var r=n.getAttribute("data-rave-view");t.destroyView(r)}}function h(){if(!a.actions){i("Could not initialize actions as the feature is not enabled in the Shindig common container.  Check the rave properties file.");return}a.actions.registerShowActionsHandler(function(t){e.each(t,function(e){o.createAction(e.id,e.label,e.path.replace("gadget","widget"),e.moduleId,e.icon,e.tooltip,function(){var t=a._siteByWidgetId[e.moduleId],n=t.getActiveSiteHolder();n&&gadgets.rpc.call(n.getIframeId(),"actions.runAction",null,e.id,null)})})}),a.actions.registerHideActionsHandler(function(t){e.each(t,function(e){o.removeAction(e.id)})})}function p(e,n,r,i){var s=e.gs._widget,o=n.split(".")[0],u=t.getView(o)?o:s._el;s._el.id===""&&t.destroyView(s._view),s.render(u,{view:n,view_params:r,ownerId:i})}function d(e,t,n,r){var i=e.gs._widget;i.savePreference(n,r)}function v(t){var n=t.gs._widget;if(n._view&&n._view.setTitle){var r=e.isArray(t.a)?t.a[0]:t.a;n._view.setTitle(r)}}function m(e,t,n,r){var i=e.gs._widget;i._view&&i._view.collapse&&i._view.collapse()}function g(e,t,n,r){var i=e.gs._widget;i._view&&i._view.expand&&i._view.expand()}function y(e){var t;return e.height?t=e.height:e.preferredHeight?t=e.preferredHeight:t=s.getDefaultHeight(),t}function b(e){var t;return e.width?t=e.width:e.preferredWidth?t=e.preferredWidth:t=s.getDefaultWidth(),t}function w(t,n){var r={};return e.each(n,function(n){var i=t[n.name];r[n.name]=e.isUndefined(i)?n.defaultValue:i}),r}function E(e){var t={};t[e.widgetUrl]=e.metadata;var n={};n[osapi.container.TokenResponse.TOKEN]=e.securityToken,n[osapi.container.MetadataResponse.RESPONSE_TIME_MS]=(new Date).getTime();var r={};r[e.widgetUrl]=n,r[e.widgetUrl+"#moduleId="+e.regionWidgetId]=n;var i={};i[osapi.container.ContainerConfig.PRELOAD_METADATAS]=t,i[osapi.container.ContainerConfig.PRELOAD_TOKENS]=r,i[osapi.container.ContainerConfig.PRELOAD_REF_TIME]=null,a.preloadCaches(i)}function S(e){return e.error}var u={},a,f={};return f[osapi.container.ServiceConfig.API_PATH]="/rpc",f[osapi.container.ContainerConfig.RENDER_DEBUG]=s.getDebugMode(),a=new osapi.container.Container(f),a._siteByWidgetId={},gadgets.pubsub2router.init({hub:r}),l(),c(),h(),u.initWidget=function(e){e.error=S(e.metadata),e.error||E(e)},u.renderWidget=function(e,t,n){if(e.error){e.renderError(t,e.error.message);return}n=n||{};var r=a.newGadgetSite(t);r._widget=e,r.moduleId_=e.regionWidgetId,e._site=r,a._siteByWidgetId[e.regionWidgetId]=r;var i={};i[osapi.container.RenderParam.VIEW]=n.view||s.getDefaultView(),i[osapi.container.RenderParam.ALLOW_DEFAULT_VIEW]=n.allowDefaultView,i[osapi.container.RenderParam.DEBUG]=n.debug||s.getDebugMode(),i[osapi.container.RenderParam.HEIGHT]=y(n),i[osapi.container.RenderParam.NO_CACHE]=n.noCache||s.getDebugMode(),i[osapi.container.RenderParam.TEST_MODE]=n.testMode||s.getDebugMode(),i[osapi.container.RenderParam.WIDTH]=b(n),i[osapi.container.RenderParam.USER_PREFS]=w(e.userPrefs,e.metadata.userPrefs),i[osapi.container.RenderParam.MODULE_ID]=e.regionWidgetId,a.navigateGadget(r,e.widgetUrl,n.view_params,i,n.callback)},u.closeWidget=function(e){e._site&&a.closeGadget(e._site)},u.getContainer=function(){return a},u});