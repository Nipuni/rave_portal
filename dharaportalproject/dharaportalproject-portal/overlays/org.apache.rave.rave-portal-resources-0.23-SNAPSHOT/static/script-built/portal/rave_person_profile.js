/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */

define(["jquery","portal/rave_portal","rave","bootstrap"],function(e,t,n){function u(){var t=e('#personProfileSubPages a[data-toggle="tab"]');if(t.length==0)return;var n=decodeURIComponent(location.hash).slice(1);n=a(n,t)?n:"",n===""&&(n=t.first().text(),location.hash=encodeURIComponent(n)),t.on("shown",function(t,n){var i=e(this).text(),s=e(this).attr("href"),o=s.split("-")[1];location.hash=encodeURIComponent(i),r[i]==0&&(r[i]=!0)}),e.each(t,function(t,i){var s=e(i),o=s.text(),u=o==n;r[o]=!1,u&&s.tab("show")})}function a(t,n){var r=!1;return e.each(n,function(e,n){n.innerHTML===t&&(r=!0)}),r}function f(e,t){for(var n=0;n<t.length;n++){var r="{"+n+"}";e=e.replace(r,t[n])}return e}function l(t){var n=document.getElementById("profileInfo"),r="."+n.value+"-hidden",i="."+n.value+"-visible";t?(e(r).show(),e(i).hide()):(e(r).hide(),e(i).show())}function c(n){var r=e("#addRemoveFriend").get(0).value,i=e("#searchTerm").get(0).value;i==undefined||i==""?e("#clearSearchButton").hide():e("#clearSearchButton").show();var s;n.result.resultSet.length<1?s=t.getClientMessage("no.results.found"):s=f(t.getClientMessage("search.list.result.x.to.y"),new Array(n.result.offset+1,n.result.resultSet.length+n.result.offset,n.result.totalResults)),e("#userSearchListHeader").text(s);var o=e("#userSearchResults");o.empty(),h(n),o.append(e("<table/>").addClass("searchdialogcontent").append(e("<tr/>").append(e("<td/>").addClass("textcell").append(e("<b/>").text(t.getClientMessage("common.username")))).append(e("<td/>").addClass("booleancell").append(e("<b/>").text(t.getClientMessage("common.friend.status"))))).append(e("<tbody/>").attr("id","searchResultsBody"))),e.each(n.result.resultSet,function(){e("#searchResultsBody").append(e("<tr/>").attr("id","searchResultRecord").append(e("<td/>").text(this.username)).append(e("<td/>").attr("id","friendStatusButtonHolder"+this.id))),this.username!=r&&(S(this.username)?e("#friendStatusButtonHolder"+this.id).append(e("<a/>").attr("href","#").attr("id",this.entityId).click(function(){d(this.id,this.username)}).text(t.getClientMessage("common.remove"))):x(this.username)?e("#friendStatusButtonHolder"+this.id).append(e("<a/>").attr("href","#").attr("id",this.entityId).click(function(){v(this.id,this.username)}).text(t.getClientMessage("common.cancel.request"))):T(this.username)?e("#friendStatusButtonHolder"+this.id).append(e("<a/>").attr("href","#").attr("id",this.entityId).click(function(){m(this.entityId,this.username)}).text(t.getClientMessage("common.accept"))," / ",e("<a/>").attr("href","#").attr("id",this.id).click(function(){g(this.id,this.username)}).text(t.getClientMessage("common.decline"))):e("#friendStatusButtonHolder"+this.id).append(e("<a/>").attr("href","#").attr("id",this.id).click(function(){p(this.id,this.username)}).text(t.getClientMessage("common.add"))))})}function h(t){var r=e("#userSearchListPaging");r.empty();if(t.result.pageSize<t.result.totalResults){r.append('<div class="pagination"><ul id="pagingul" >'),t.result.currentPage>1&&(offset=(t.result.currentPage-2)*t.result.pageSize,e("#pagingul").append('<li><a href="#" class="paginationLink" data-offset="'+offset+'">'+"&lt;</a></li>"));for(var i=1;i<=t.result.numberOfPages;i++)i==t.result.currentPage?e("#pagingul").append('<li class="active"><a href="#">'+i+"</a></li>"):(offset=(i-1)*t.result.pageSize,e("#pagingul").append('<li><a href="#" class="paginationLink" data-offset="'+offset+'">'+i+"</a></li>"));t.result.currentPage<t.result.numberOfPages&&(offset=t.result.currentPage*t.result.pageSize,e("#pagingul").append('<li><a href="#" class="paginationLink" data-offset="'+offset+'">'+"&gt;</a></li>")),r.append("</ul></div>")}e(".paginationLink").click(function(){n.api.rpc.getUsers({offset:e(this).data("offset"),successCallback:function(e){c(e)}})})}function p(r,i){e("#friendStatusButtonHolder"+r).hide(),n.api.rpc.addFriend({friendUsername:i,successCallback:function(n){y(i),e("#friendStatusButtonHolder"+r).empty(),e("#friendStatusButtonHolder"+r).append(e("<a/>").attr("href","#").attr("id",r).click(function(){v(r,i)}).text(t.getClientMessage("common.cancel.request"))),e("#friendStatusButtonHolder"+r).show()}})}function d(r,i){var s=f(t.getClientMessage("remove.friend.confirm"),new Array(i));confirm(s)&&(e("#friendStatusButtonHolder"+r).hide(),n.api.rpc.removeFriend({friendUsername:i,successCallback:function(n){b(i),e("#friendStatusButtonHolder"+r).empty(),e("#friendStatusButtonHolder"+r).append(e("<a/>").attr("href","#").attr("id",r).click(function(){p(r,i)}).text(t.getClientMessage("common.add"))),e("#friendStatusButtonHolder"+r).show()}}))}function v(r,i){var s=f(t.getClientMessage("remove.friend.request.confirm"),new Array(i));confirm(s)&&(e("#friendStatusButtonHolder"+r).hide(),n.api.rpc.removeFriend({friendUsername:i,successCallback:function(n){w(i),e("#friendStatusButtonHolder"+r).empty(),e("#friendStatusButtonHolder"+r).append(e("<a/>").attr("href","#").attr("id",r).click(function(){p(r,i)}).text(t.getClientMessage("common.add"))),e("#friendStatusButtonHolder"+r).show()}}))}function m(r,i){e("#friendStatusButtonHolder"+r).hide(),n.api.rpc.acceptFriendRequest({friendUsername:i,successCallback:function(n){E(i),e("#friendStatusButtonHolder"+r).empty(),e("#friendStatusButtonHolder"+r).append(e("<a/>").attr("href","#").attr("id",r).click(function(){d(r,i)}).text(t.getClientMessage("common.remove"))),e("#friendStatusButtonHolder"+r).show()}})}function g(r,i){e("#friendStatusButtonHolder"+r).hide(),n.api.rpc.removeFriend({friendUsername:i,successCallback:function(n){E(i),e("#friendStatusButtonHolder"+r).empty(),e("#friendStatusButtonHolder"+r).append(e("<a/>").attr("href","#").attr("id",r).click(function(){p(r,i)}).text(t.getClientMessage("common.add"))),e("#friendStatusButtonHolder"+r).show()}})}function y(e){s.push(e)}function b(e){i.splice(i.indexOf(e),1)}function w(e){s.splice(s.indexOf(e),1)}function E(e){o.splice(o.indexOf(e),1)}function S(e){return i.indexOf(e)>=0?!0:!1}function x(e){return s.indexOf(e)>=0?!0:!1}function T(e){return o.indexOf(e)>=0?!0:!1}function N(){var r=e("#profileEdit");r&&r.click(function(){l(!0)});var i=e("#addRemoveFriend");i&&i.click(function(){C({successCallback:function(){n.api.rpc.getUsers({offset:0,successCallback:function(t){c(t),e("#userDialog").modal("show")}})}})}),e("#userSearchButton").click(function(){e("#userSearchResults").empty(),n.api.rpc.searchUsers({searchTerm:e("#searchTerm").get(0).value,offset:0,successCallback:function(e){c(e)},alertEmptySearch:function(){alert(t.getClientMessage("api.rpc.empty.search.term"))}})}),e("#clearSearchButton").click(function(){e("#searchTerm").get(0).value="",e("#userSearchResults").empty(),n.api.rpc.getUsers({offset:0,successCallback:function(e){c(e)}})});var s=e("#cancelEdit");s&&s.click(function(){l(!1)});var o=e(".acceptFriendRequest");o&&o.click(function(r){n.api.rpc.acceptFriendRequest({friendUsername:this.id});var i=e(this).parents(".requestItem"),s=e(i).parent();e(i).remove(),e(".friendRequestDropdown").append('<li class="message">'+t.getClientMessage("common.accepted")+"</li>"),e(".message").fadeOut(2e3,function(){e(".message").remove();var n=e(s).children("li");e(".friendRequestDropdownLink").html(""+t.getClientMessage("person.profile.friend.requests")+" ("+n.size()+")"),n.size()==0&&e(".friendRequestDropdown").append("<li>"+t.getClientMessage("person.profile.friend.requests.none")+"</li>")}),r.stopPropagation()});var u=e(".declineFriendRequest");u&&u.click(function(r){n.api.rpc.removeFriend({friendUsername:this.id});var i=e(this).parents(".requestItem"),s=e(i).parent();e(i).remove(),e(".friendRequestDropdown").append('<li class="message">'+t.getClientMessage("common.declined")+"</li>"),e(".message").fadeOut(2e3,function(){e(".message").remove();var n=e(s).children("li");e(".friendRequestDropdownLink").html(""+t.getClientMessage("person.profile.friend.requests")+" ("+n.size()+")"),n.size()==0&&e(".friendRequestDropdown").append("<li>"+t.getClientMessage("person.profile.friend.requests.none")+"</li>")}),r.stopPropagation()})}function C(t){n.api.rpc.getFriends({successCallback:function(n){e.each(n.result.accepted,function(){S(this.username)||i.push(this.username)}),e.each(n.result.sent,function(){x(this.username)||s.push(this.username)}),e.each(n.result.received,function(){T(this.username)||o.push(this.username)}),n!=null&&typeof t.successCallback=="function"&&t.successCallback()}})}function k(){u(),N()}var r={},i=new Array,s=new Array,o=new Array;return n.registerOnInitHandler(k),{dealWithUserResults:c,addFriend:p,removeFriend:d,removeFriendUI:b,removeFriendRequestSent:v,addFriendRequestUI:y,removeFriendRequestSentUI:w,isUserAlreadyFriend:S,isFriendRequestSent:x,isFriendRequestReceived:T,removeFriendRequestReceivedUI:E,getFriends:C,acceptFriendRequest:m,declineFriendRequest:g}});