/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */

define(["jquery","rave","portal/rave_portal","portal/rave_models","bootstrap","jqueryValidate"],function($,rave,ravePortal,raveModels){function moveWidgetToPage(e){var t=$("#moveToPageId").val(),n={toPageId:t,regionWidgetId:e,successCallback:function(){ravePortal.viewPage(t)}};rave.api.rpc.moveWidgetToPage(n)}function addPage(){if(showImportExportUI){if($pageFormTabbed.valid()){var e=$("#tab_titleTabbed1").val(),t=$("#pageLayoutTabbed").val();rave.api.rpc.addPage({pageName:e,pageLayoutCode:t,errorLabel:"pageFormErrorsTabbed1",successCallback:function(e){ravePortal.viewPage(e.result.id)},errorCallback:function(e){$("#"+e).html(ravePortal.getClientMessage("page.duplicate_name"))}})}}else if($pageForm.valid()){var e=$tab_title_input.val(),t=$page_layout_input.val();rave.api.rpc.addPage({pageName:e,pageLayoutCode:t,errorLabel:"pageFormErrors",successCallback:function(e){ravePortal.viewPage(e.result.id)},errorCallback:function(e){$("#"+e).html(ravePortal.getClientMessage("page.duplicate_name"))}})}}function importPage(){$.browser.msie==1?alert(ravePortal.getClientMessage("import.page.not.supported")):$pageFormImport.valid()&&($pageFormImport.get(0).setAttribute("action",rave.getContext()+"api/rpc/page/import/omdl"),document.getElementById("pageFormImport").onsubmit=function(){document.getElementById("pageFormImport").target="file_upload_frame",document.getElementById("file_upload_frame").onload=processFileUploadResult},$pageFormImport.submit())}function processFileUploadResult(){var ret=frames.file_upload_frame.document.getElementsByTagName("body")[0].firstChild.innerHTML,data=eval("("+ret+")");if(data.error)if(data.errorCode=="DUPLICATE_ITEM")$("#pageFormErrorsTabbed2").html(ravePortal.getClientMessage("page.duplicate_name"));else if(data.errorCode=="INTERNAL_ERROR"&&data.errorMessage.indexOf("BadOmdlXmlFormatException")!=-1){var msg=data.errorMessage.substr(data.errorMessage.indexOf("BadOmdlXmlFormatException"),data.errorMessage.length);$("#pageFormErrorsTabbed2").html(msg)}else alert(ravePortal.getClientMessage("api.rpc.error.internal"));else ravePortal.viewPage(data.result.id)}function addOrImportPage(){var e=$("#page-tabs").tabs("option","selected");e==0?addPage():importPage()}function movePage(){var e=$("#moveAfterPageId").val(),t={pageId:$("#currentPageId").val(),successCallback:function(e){ravePortal.viewPage(e.result.id)}};e!=MOVE_PAGE_DEFAULT_POSITION_IDX&&(t.moveAfterPageId=e),rave.api.rpc.movePage(t)}function updatePage(){$pageForm.valid()&&rave.api.rpc.updatePagePrefs({pageId:$tab_id.val(),title:$tab_title_input.val(),layout:$page_layout_input.val(),errorLabel:"pageFormErrors",successCallback:function(e){ravePortal.viewPage(e.result.id)},errorCallback:function(e){$("#"+e).html(ravePortal.getClientMessage("page.duplicate_name"))}})}function closePageDialog(){$pageForm[0].reset(),$tab_id.val(""),$("#pageFormErrors").text(""),$("#pageMenuDialog").modal("hide")}function closePageDialogTabbed(){$pageForm[0].reset(),$("#pageFormErrors").text(""),$("#pageFormErrorsTabbed1").text(""),$("#pageFormErrorsTabbed2").text(""),$pageFormTabbed[0].reset(),$pageFormImport[0].reset(),$("#pageMenuDialogTabbed").modal("hide")}function getCurrentPageId(){return rave.getPage().id}function isWidgetOnHiddenTab(e){var t=decodeURIComponent(location.hash),n=e.subPage;return!(n.id===null||"#"+n.name===t||t===""&&n.isDefault)}function init(){pageMenu.init(rave.getExportEnabled())}var MOVE_PAGE_DEFAULT_POSITION_IDX=-1,$moveWidgetDialog,showImportExportUI=!1,$movePageDialog=$("#movePageDialog"),$pageFormTabbed=$("#pageFormTabbed"),$pageFormImport=$("#pageFormImport"),$omdlFile=$("#omdlFile"),$pageForm=$("#pageForm"),$tab_title_input=$("#tab_title"),$tab_id=$("#tab_id"),$page_layout_input=$("#pageLayout"),pageMenu=function(){function u(i){showImportExportUI=i,$pageForm.validate({errorElement:"span",errorClass:"help-inline",highlight:function(e,t){$(e).parent().parent().addClass("error")},unhighlight:function(e,t){$(e).parent().parent().removeClass("error")}}),$pageFormTabbed.validate({errorElement:"span",errorClass:"help-inline",highlight:function(e,t){$(e).parent().parent().addClass("error")},unhighlight:function(e,t){$(e).parent().parent().removeClass("error")}}),$pageFormImport.validate({errorElement:"span",errorClass:"help-inline",highlight:function(e,t){$(e).parent().parent().addClass("error")},unhighlight:function(e,t){$(e).parent().parent().removeClass("error")}}),$("#pageMenuCloseButton").click(closePageDialog),$("#pageMenuCloseButtonTab").click(closePageDialogTabbed),i&&$("#pageMenuExport").removeClass("hidden"),e.bind("click",function(e){if(i){var t=$("#pageMenuUpdateButtonTab");t.html(ravePortal.getClientMessage("common.add")),$("#page-tabs").tabs(),t.click(addOrImportPage),$("#pageMenuDialogTabbed").on("shown",function(){$("#tab_title").first().focus()}),$("#pageMenuDialogTabbed").modal("show")}else{$("#pageMenuDialogHeader").html(ravePortal.getClientMessage("page.add"));var n=$("#pageMenuUpdateButton");$("#pageLayoutGroup").show(),n.html(ravePortal.getClientMessage("common.add")),n.unbind("click"),n.click(addPage),$("#pageMenuDialog").on("shown",function(){$("#tab_title").first().focus()}),$("#pageMenuDialog").modal("show")}}),t.bind("click",function(e){rave.api.rpc.getPagePrefs({pageId:getCurrentPageId(),successCallback:function(e){$tab_title_input.val(e.result.name),$tab_id.val(e.result.id),$page_layout_input.val(e.result.pageLayout.code),$("#pageMenuDialogHeader").html(ravePortal.getClientMessage("page.update"));var t=$("#pageMenuUpdateButton");$("#pageLayoutGroup").show(),t.html(ravePortal.getClientMessage("common.save")),t.unbind("click"),t.click(updatePage),$("#pageMenuDialog").on("shown",function(){$("#tab_title").first().focus()}),$("#pageMenuDialog").modal("show")}})}),n.hasClass("menu-item-disabled")||n.bind("click",function(e){rave.api.rest.deletePage({pageId:getCurrentPageId(),successCallback:ravePortal.viewPage})}),r.hasClass("menu-item-disabled")||r.bind("click",function(e){$movePageDialog.modal("show")}),o.hasClass("hidden")||o.bind("click",function(e){window.open(rave.getContext()+"api/rest/"+"page/"+getCurrentPageId()+"/omdl")}),s.hasClass("menu-item-disabled")||s.bind("click",function(e){raveModels.currentPage.removeForSelf()})}var e=$("#addPageButton"),t=$("#pageMenuEdit"),n=$("#pageMenuDelete"),r=$("#pageMenuMove"),i=$("#pageMenuShare"),s=$("#pageMenuRevokeShare"),o=$("#pageMenuExport");return{init:u}}();return rave.registerOnInitHandler(init),{addPage:addPage,addOrImportPage:addOrImportPage,updatePage:updatePage,movePage:movePage,importPage:importPage,closePageDialog:closePageDialog,closePageDialogTabbed:closePageDialogTabbed,moveWidgetToPage:moveWidgetToPage,isWidgetOnHiddenTab:isWidgetOnHiddenTab}});